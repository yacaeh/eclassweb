stages:
  - build
  - test
  - deploy
  - production
  
image: node:latest

cache:
  paths:
    - node_modules/

build:
    stage: build
    script:
      - npm install
    artifacts:
      paths:
        - node_modules/
test:
    stage: test
    script:
      - npm install
      - npm test
    artifacts:
        paths:
        - node_modules/

      
deploy-test:
  stage: deploy
  environment:
    name: staging

  before_script:
    - apt-get update -qq
    - apt-get install -y -qq ssh
    - apt-get install -y -qq rsync
    - apt-get install -y -qq sshpass
    - mkdir ~/.ssh
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config  
    - export SSHPASS=$DGX_PASS 
  
  script:
    - sshpass -e rsync -avz --exclude='.git' --exclude='.gitlab-ci.yml' . $DGX_USER@$DGX_HOST:$DGX_HOST_DIR
    - npm install
    - node server.js && exit
  only:
    - develop
  

deploy-production:
  stage: production
    
  environment:
    name: deploying

  before_script:
    - apt-get update -qq
    - apt-get install -y -qq ssh
    - apt-get install -y -qq rsync
    - apt-get install -y -qq sshpass
    - mkdir ~/.ssh
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config  
    - export SSHPASS=$DGX_PASS 
  script:
    - sshpass -e rsync -avz --exclude='.git' --exclude='.gitlab-ci.yml' . $REMOTE_USER@$REMOTE_HOST:$REMOTE_HOST_DIR
    - npm install
    - node server.js && exit
  only:
    - master